name: Model Training

on:
  # Manual trigger only - for production use after data is loaded
  workflow_dispatch:
    inputs:
      use_test_data:
        description: 'Use synthetic test data (for CI testing)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  train-models:
    name: Train ML Models (Docker)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create environment file
      run: |
        cat > .env << EOF
        DB_HOST=bike_demand_postgres
        DB_PORT=5432
        DB_USER=postgres
        DB_PASSWORD=postgres
        DB_DATABASE=bike_demand_db
        MLFLOW_TRACKING_URI=http://bike_demand_mlflow:5000
        WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
        ENVIRONMENT=ci
        EOF

    - name: Start infrastructure
      run: |
        cd infrastructure
        docker compose up -d postgres mlflow
        sleep 10

    - name: Wait for PostgreSQL
      run: |
        timeout 60 bash -c 'until docker exec bike_demand_postgres pg_isready; do sleep 2; done'

    - name: Initialize database
      run: |
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db < infrastructure/postgres/schema.sql

    - name: Build training image
      run: |
        docker build -t bike-demand-trainer:latest -f docker/training/Dockerfile .

    - name: Generate synthetic test data
      if: ${{ github.event.inputs.use_test_data != 'false' }}
      run: |
        echo "üìä Generating synthetic test data for CI training..."
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db << 'SQL'
        -- Insert test bike stations
        INSERT INTO bike_stations (station_id, name, latitude, longitude, capacity, is_active) VALUES
        ('test-station-1', 'Test Station 1', 40.7589, -73.9851, 30, true),
        ('test-station-2', 'Test Station 2', 40.7614, -73.9776, 40, true),
        ('test-station-3', 'Test Station 3', 40.7527, -73.9772, 35, true);

        -- Insert historical bike station status (last 35 days, hourly = 840 hours, extra buffer for timezone)
        INSERT INTO bike_station_status (station_id, timestamp, bikes_available, docks_available)
        SELECT
          s.station_id,
          CURRENT_TIMESTAMP - ((840 - i) || ' hours')::INTERVAL as timestamp,
          FLOOR(RANDOM() * 20 + 5)::INT as bikes_available,
          FLOOR(RANDOM() * 15 + 5)::INT as docks_available
        FROM bike_stations s
        CROSS JOIN generate_series(1, 840) i
        WHERE s.station_id LIKE 'test-station-%';

        -- Insert weather data (last 35 days, hourly, matching bike data)
        INSERT INTO weather_data (timestamp, temperature, feels_like, humidity, wind_speed, precipitation, weather_condition, visibility, pressure)
        SELECT
          CURRENT_TIMESTAMP - ((840 - i) || ' hours')::INTERVAL as timestamp,
          15 + RANDOM() * 15 as temperature,
          15 + RANDOM() * 15 as feels_like,
          40 + RANDOM() * 40 as humidity,
          RANDOM() * 20 as wind_speed,
          RANDOM() * 5 as precipitation,
          (ARRAY['Clear', 'Clouds', 'Rain'])[FLOOR(RANDOM() * 3 + 1)] as weather_condition,
          8000 + RANDOM() * 2000 as visibility,
          1000 + RANDOM() * 30 as pressure
        FROM generate_series(1, 840) i;

        \echo '‚úÖ Test data loaded:'
        SELECT 'Stations' as type, COUNT(*) as count FROM bike_stations WHERE station_id LIKE 'test-station-%'
        UNION ALL
        SELECT 'Status records', COUNT(*) FROM bike_station_status
        UNION ALL
        SELECT 'Weather records', COUNT(*) FROM weather_data;
        SQL

    - name: Generate features from raw data
      if: ${{ github.event.inputs.use_test_data != 'false' }}
      run: |
        echo "üîß Running feature engineering on synthetic data..."
        docker run --rm \
          --network infrastructure_bike_demand_network \
          -e DB_HOST=bike_demand_postgres \
          -e DB_PORT=5432 \
          -e DB_USER=postgres \
          -e DB_PASSWORD=postgres \
          -e DB_DATABASE=bike_demand_db \
          --entrypoint python \
          bike-demand-trainer:latest \
          scripts/generate_features.py

    - name: Verify features were created
      if: ${{ github.event.inputs.use_test_data != 'false' }}
      run: |
        echo "üîç Verifying features table..."
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db -c "SELECT COUNT(*) as feature_count, feature_version FROM features GROUP BY feature_version;"
        echo "Sample feature record:"
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db -c "SELECT station_id, timestamp, feature_version FROM features LIMIT 5;"
        echo "Timestamp range in features:"
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db -c "SELECT MIN(timestamp) as min_ts, MAX(timestamp) as max_ts FROM features;"
        echo "Timestamp range in bike_station_status:"
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db -c "SELECT MIN(timestamp) as min_ts, MAX(timestamp) as max_ts FROM bike_station_status;"

    - name: Run training container
      run: |
        echo "üöÇ Starting model training..."
        docker run --rm \
          --network infrastructure_bike_demand_network \
          -e DB_HOST=bike_demand_postgres \
          -e DB_PORT=5432 \
          -e DB_USER=postgres \
          -e DB_PASSWORD=postgres \
          -e DB_DATABASE=bike_demand_db \
          -e MLFLOW_TRACKING_URI=http://bike_demand_mlflow:5000 \
          bike-demand-trainer:latest

    - name: Cleanup
      if: always()
      run: |
        cd infrastructure
        docker compose down -v

    - name: Create training summary
      run: |
        echo "## Training Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Training Mode**: Docker container" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Data**: ${{ github.event.inputs.use_test_data }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Models trained successfully using production Docker setup." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Training Results
    needs: [train-models]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Training Success Notification
      if: needs.train-models.result == 'success'
      run: |
        echo "‚úÖ Model training completed successfully"
        # Add notification logic here (Slack, email, etc.)

    - name: Training Failure Notification
      if: needs.train-models.result == 'failure'
      run: |
        echo "‚ùå Model training failed"
        # Add notification logic here (Slack, email, etc.)
