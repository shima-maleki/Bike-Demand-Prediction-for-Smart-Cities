name: Model Training

on:
  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  train-models:
    name: Train ML Models (Docker)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create environment file
      run: |
        cat > .env << EOF
        DB_HOST=bike_demand_postgres
        DB_PORT=5432
        DB_USER=postgres
        DB_PASSWORD=postgres
        DB_DATABASE=bike_demand_db
        MLFLOW_TRACKING_URI=http://bike_demand_mlflow:5000
        WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
        ENVIRONMENT=ci
        EOF

    - name: Start infrastructure
      run: |
        cd infrastructure
        docker compose up -d postgres mlflow
        sleep 10

    - name: Wait for PostgreSQL
      run: |
        timeout 60 bash -c 'until docker exec bike_demand_postgres pg_isready; do sleep 2; done'

    - name: Initialize database
      run: |
        docker exec -i bike_demand_postgres psql -U postgres -d bike_demand_db < infrastructure/postgres/schema.sql

    - name: Build training image
      run: |
        docker build -t bike-demand-trainer:latest -f docker/training/Dockerfile .

    - name: Run training container
      run: |
        docker run --rm \
          --network infrastructure_bike_demand_network \
          -e DB_HOST=bike_demand_postgres \
          -e DB_PORT=5432 \
          -e DB_USER=postgres \
          -e DB_PASSWORD=postgres \
          -e DB_DATABASE=bike_demand_db \
          -e MLFLOW_TRACKING_URI=http://bike_demand_mlflow:5000 \
          bike-demand-trainer:latest

    - name: Cleanup
      if: always()
      run: |
        cd infrastructure
        docker compose down -v

    - name: Create training summary
      run: |
        echo "## Training Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Training Mode**: Docker container" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Models trained successfully using production Docker setup." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Training Results
    needs: [train-models]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Training Success Notification
      if: needs.train-models.result == 'success'
      run: |
        echo "✅ Model training completed successfully"
        # Add notification logic here (Slack, email, etc.)

    - name: Training Failure Notification
      if: needs.train-models.result == 'failure'
      run: |
        echo "❌ Model training failed"
        # Add notification logic here (Slack, email, etc.)
